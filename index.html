<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GooglePay v26.24.3</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-surface: #FEF7FF;
            --md-sys-color-surface-container: #F3EDF7;
            --md-sys-color-surface-container-high: #ECE6F0;
            --md-sys-color-on-surface: #1D1B20;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1D192B;
            --md-sys-color-error: #B3261E;
        }

        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--md-sys-color-surface); color: var(--md-sys-color-on-surface); margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        body.no-scroll { overflow: hidden; }

        #sync-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--md-sys-color-surface); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; box-sizing: border-box; }

        .summary-header { background-color: var(--md-sys-color-surface-container); margin: 16px; padding: 24px 24px 36px 24px; border-radius: 32px; position: relative; }
        .version-tag { position: absolute; right: 20px; bottom: 12px; font-size: 8px; color: #555555; opacity: 0.8; font-weight: 500; cursor: pointer; padding: 4px; border-radius: 4px; }
        .sync-status { position: absolute; left: 50%; bottom: 16px; transform: translateX(-50%); font-size: 9px; color: var(--md-sys-color-outline); display: flex; align-items: center; justify-content: center; white-space: nowrap; }

        .month-selector { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .month-label { font-size: 20px; font-weight: 700; color: var(--md-sys-color-primary); }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .summary-item { background: white; padding: 16px; border-radius: 20px; cursor: pointer; }
        .summary-item small { display: block; color: var(--md-sys-color-on-surface-variant); font-size: 12px; }
        .summary-item span { font-size: 18px; font-weight: 700; }

        .transaction-section { padding: 0 16px; flex-grow: 1; }
        .list-toggle-container { display: flex; justify-content: center; margin-bottom: 12px; width: 100%; }
        .small-segmented-control { display: flex; background: var(--md-sys-color-surface-container-high); padding: 4px; border-radius: 100px; width: 180px; }
        .small-segment-btn { flex: 1; border: none; background: none; padding: 8px; border-radius: 100px; font-size: 13px; font-weight: 500; cursor: pointer; color: var(--md-sys-color-on-surface-variant); }
        .small-segment-btn.active { background: white; color: var(--md-sys-color-primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .main-chart-container { background: white; margin: 0 16px 16px 16px; padding: 12px; border-radius: 24px; height: 160px; display: flex; justify-content: center; align-items: center; box-sizing: border-box; overflow: hidden; }
        
        .list-card { background: white; border-radius: 24px; padding: 8px 0; margin: 0 16px 120px 16px; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--md-sys-color-surface-container); cursor: pointer; }
        .item-info { display: flex; flex-direction: column; flex: 1; }
        .item-title-row { display: flex; align-items: center; gap: 8px; }
        .note-pill { background-color: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container); padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 500; white-space: nowrap; max-width: 140px; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1000; align-items: flex-end; }
        .modal-overlay.active { display: flex; }
        
        .bottom-sheet { background: var(--md-sys-color-surface); width: 100%; border-radius: 32px 32px 0 0; padding: 24px; box-sizing: border-box; max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; scrollbar-gutter: stable; }
        .bottom-sheet.custom-height { height: 72.5vh; max-height: 72.5vh; }
        #sheetBody { flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-start; overflow-y: auto; }

        .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-shrink: 0; min-height: 48px; }
        .header-actions { display: flex; flex-direction: row; gap: 8px; align-items: center; }
        .sheet-handle { width: 32px; height: 4px; background: var(--md-sys-color-outline); border-radius: 2px; margin: 0 auto 24px auto; opacity: 0.4; flex-shrink: 0; }
        .circle-btn { width: 40px; height: 40px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        .input-group { margin-bottom: 18px; position: relative; }
        .input-label { font-size: 14px; font-weight: 500; color: var(--md-sys-color-primary); margin-bottom: 6px; display: block; padding-left: 4px; }
        .md-input { width: 100%; padding: 14px 16px; border: 1.5px solid var(--md-sys-color-outline); border-radius: 16px; font-size: 16px; background: transparent; box-sizing: border-box; color: var(--md-sys-color-on-surface); }

        .btn-row { display: flex; gap: 12px; margin-top: 24px; flex-shrink: 0; }
        #modalActions { display: flex; flex-direction: column; margin-top: 20px; gap: 8px; flex-shrink: 0; }
        .btn-filled { background: var(--md-sys-color-primary); color: white; border: none; padding: 16px; width: 100%; border-radius: 100px; font-size: 16px; font-weight: 700; cursor: pointer; }
        .btn-tonal { background: var(--md-sys-color-secondary-container); color: var(--md-sys-color-on-secondary-container); border: none; padding: 16px; width: 100%; border-radius: 100px; font-size: 16px; font-weight: 700; cursor: pointer; }
        .btn-text-error { background: none; color: var(--md-sys-color-error); border: none; padding: 12px; width: 100%; font-weight: 700; cursor: pointer; border-radius: 100px; }

        .md-alert-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: none; align-items: center; justify-content: center; padding: 24px; }
        .md-alert { background: var(--md-sys-color-surface-container-high); border-radius: 28px; padding: 24px; max-width: 320px; width: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .md-alert-title { font-size: 24px; margin-bottom: 16px; color: var(--md-sys-color-on-surface); }
        .md-alert-content { font-size: 16px; line-height: 1.5; color: var(--md-sys-color-on-surface-variant); margin-bottom: 24px; }

        .stats-detail-card { background: var(--md-sys-color-surface-container-high); padding: 16px; border-radius: 20px; margin-bottom: 16px; border: 1px solid rgba(0,0,0,0.05); }
        .detail-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed var(--md-sys-color-outline); opacity: 0.8; }
        .detail-row:last-child { border-bottom: none; }
        .detail-row span:first-child { font-weight: 700; color: var(--md-sys-color-on-surface); }
        .detail-row span:last-child { font-weight: 700; color: var(--md-sys-color-primary); }

        .amt-wrapper { position: relative; display: flex; align-items: center; width: 100%; }
        .calc-toggle { position: absolute; right: 12px; color: var(--md-sys-color-primary); cursor: pointer; }
        .op-popup { position: absolute; right: 0; top: -52px; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 12px; display: none; padding: 4px; gap: 4px; z-index: 10; border: 1px solid var(--md-sys-color-outline); }
        .op-popup.active { display: flex; }
        .op-btn { width: 40px; height: 40px; border-radius: 8px; border: none; background: var(--md-sys-color-surface-container-high); font-size: 18px; font-weight: 700; color: var(--md-sys-color-primary); }

        .fab { position: fixed; right: 20px; bottom: 32px; width: 64px; height: 64px; border-radius: 20px; background: var(--md-sys-color-primary-container); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 100; cursor: pointer; }
        .fab-left { position: fixed; left: 20px; bottom: 32px; width: 64px; height: 64px; border-radius: 20px; background: var(--md-sys-color-secondary-container); display: flex; align-items: center; justify-content: center; z-index: 100; cursor: pointer; }
        .fab-menu { position: fixed; right: 20px; bottom: 105px; display: none; flex-direction: column; gap: 12px; z-index: 100; align-items: flex-end; }
        .fab-item { background: #F5F5F5; padding: 12px 20px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-weight: 500; cursor: pointer; }

        .category-row { display: flex; align-items: center; background: var(--md-sys-color-surface-container-high); margin-bottom: 8px; padding: 12px; border-radius: 16px; gap: 12px; cursor: move; }
        .sub-row { display: flex; align-items: center; background: white; margin-bottom: 12px; padding: 16px; border-radius: 20px; gap: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
        .segmented-control { display: flex; background: var(--md-sys-color-surface-container-high); padding: 4px; border-radius: 100px; margin-bottom: 24px; flex-shrink: 0; }
        .segment-btn { flex: 1; border: none; background: none; padding: 10px; border-radius: 100px; font-size: 14px; font-weight: 500; cursor: pointer; }
        .segment-btn.active { background: white; color: var(--md-sys-color-primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .stats-report-item { background: white; padding: 16px; border-radius: 20px; margin-bottom: 12px; border: 1px solid var(--md-sys-color-surface-container-high); cursor: pointer; }
        .log-item { margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #ECE6F0; }
        .log-version { display: inline-block; background: #6750A4; color: white; padding: 2px 8px; border-radius: 6px; font-size: 12px; font-weight: 700; margin-bottom: 8px; }
        .log-content { font-size: 14px; line-height: 1.6; color: #49454F; }
        .log-content div { position: relative; padding-left: 14px; margin-bottom: 4px; }
        .log-content div::before { content: "•"; position: absolute; left: 0; color: #6750A4; font-weight: bold; }
    </style>
</head>
<body>

    <div id="sync-overlay">
        <h2 style="color:var(--md-sys-color-primary); margin-bottom:8px;">GooglePay v26.24.3</h2>
        <input type="text" id="account-id" class="md-input" placeholder="原本的帳號 ID" style="margin-bottom:12px; text-align:center;">
        <input type="password" id="account-pw" class="md-input" placeholder="請設定一組新密碼" style="margin-bottom:24px; text-align:center;">
        <button class="btn-filled" style="width:200px;" id="loginBtn" onclick="startApp()">登入 / 同步</button>
        <p style="font-size:11px; color:var(--md-sys-color-outline); margin-top:20px; line-height:1.5; padding:0 20px; text-align:center;">
            ※ 首次輸入即為帳號設定。<br>
            ※ 若顯示失敗，請確認 Firebase 後台已開啟 Email 登入。
        </p>
    </div>

    <div id="app-content" style="display:none;">
        <div class="summary-header">
            <div class="month-selector">
                <span class="material-symbols-outlined" onclick="changeMonth(-1)">chevron_left</span>
                <div class="month-label" id="dateLabel">2026年 1月</div>
                <span class="material-symbols-outlined" onclick="changeMonth(1)">chevron_right</span>
            </div>
            <div class="summary-grid">
                <div class="summary-item" onclick="toggleIncomeDisplay()">
                    <small>總收入</small><span id="totalIncome" style="color:#2E7D32;">-----</span>
                </div>
                <div class="summary-item"><small>總支出</small><span id="totalExpense" style="color:#C62828;">$0</span></div>
            </div>
            <div class="sync-status" id="cloud-status">正在連線...</div>
            <div class="version-tag" onclick="openDrawer('changelog')">v26.24.3</div>
        </div>
        <div class="transaction-section">
            <div class="list-toggle-container">
                <div class="small-segmented-control">
                    <button class="small-segment-btn" id="btnListExp" onclick="setListTab('expense')">支出</button>
                    <button class="small-segment-btn" id="btnListInc" onclick="setListTab('income')">收入</button>
                </div>
            </div>
            <div class="main-chart-container"><canvas id="mainPieChart"></canvas></div>
            <div class="list-card" id="listContent"></div>
        </div>
        <div class="fab-left" onclick="openDrawer('stats')"><span class="material-symbols-outlined">analytics</span></div>
        <div class="fab-menu" id="fabMenu">
            <div class="fab-item" onclick="openDrawer('expense')">新增支出</div>
            <div class="fab-item" onclick="openDrawer('income')">新增收入</div>
            <div class="fab-item" onclick="openDrawer('subManage')">訂閱管理</div>
            <div class="fab-item" onclick="openDrawer('category')">類別管理</div>
            <div class="fab-item" style="color:var(--md-sys-color-error);" onclick="logout()">登出帳號</div>
        </div>
        <div class="fab" onclick="toggleFab()"><span class="material-symbols-outlined" id="fabIcon">add</span></div>
        <div class="modal-overlay" id="modalOverlay" onclick="closeDrawer()">
            <div class="bottom-sheet" id="mainSheet" onclick="event.stopPropagation()">
                <div class="sheet-handle"></div>
                <div id="sheetBody"></div>
                </div>
        </div>
    </div>

    <script>
        // Firebase Config (與您原先的一致)
        const firebaseConfig = {
            apiKey: "AIzaSyAi5Kqw8RFddkF1B2P0NjMpQEc0puYqFyw",
            authDomain: "pay-4a919.firebaseapp.com",
            databaseURL: "https://pay-4a919-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pay-4a919",
            storageBucket: "pay-4a919.firebasestorage.app",
            messagingSenderId: "156357220142",
            appId: "1:156357220142:web:3754cb6516bcd299b00cbf",
            measurementId: "G-TX1C3KZMGZ"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let state = { uid: '', records: [], cats: [{ id: 1, name: '餐飲', type: 'expense', sort: 0 }], subs: [], listTab: 'expense', viewDate: new Date(2026, 0, 1), showIncome: false };

        const changelogs = [
            { v: "v26.24.3", items: ["強化登入相容性：自動處理 Firebase 新舊錯誤代碼，確保舊帳戶能順利設定第一組密碼。"] },
            { v: "v26.24.2", items: ["優化登入持久化：自動保持登入狀態。"] },
            { v: "v26.1", items: ["版本號系統與雲端同步樣式優化"] }
        ];

        // 核心修正：更強韌的登入/註冊邏輯
        async function startApp() {
            const accId = document.getElementById('account-id').value.trim();
            const password = document.getElementById('account-pw').value.trim();

            if (!accId || password.length < 6) return alert('請輸入帳號並確保密碼至少 6 位');

            const loginBtn = document.getElementById('loginBtn');
            loginBtn.innerText = '正在同步帳號...';
            loginBtn.disabled = true;

            const email = `${accId}@googlepay.sys`;

            try {
                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                // 嘗試登入
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                handleAuthSuccess(userCredential.user);
            } catch (error) {
                console.log("Auth Error Code:", error.code);
                // 只要是帳號不存在或憑證無效(對應新帳號)，就嘗試建立
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
                    // 如果是密碼錯誤(針對已註冊過的帳號)，則報錯
                    if (error.code === 'auth/wrong-password') {
                        alert('密碼錯誤！如果您是第一次設定，請確保 ID 正確。');
                    } else {
                        // 否則視為新用戶，嘗試註冊
                        try {
                            const newUser = await auth.createUserWithEmailAndPassword(email, password);
                            alert('新帳號密碼設定成功！');
                            handleAuthSuccess(newUser.user);
                        } catch (regError) {
                            alert('註冊失敗：' + regError.message + '\n請確認 Firebase 後台已開啟 Email 登入功能。');
                        }
                    }
                } else {
                    alert('系統錯誤: ' + error.code);
                }
            } finally {
                loginBtn.innerText = '登入 / 同步';
                loginBtn.disabled = false;
            }
        }

        function handleAuthSuccess(user) {
            state.uid = user.uid;
            document.getElementById('sync-overlay').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            listenToCloud();
        }

        function listenToCloud() {
            db.ref('users/' + state.uid).on('value', (snap) => {
                const data = snap.val();
                if (data) {
                    state.records = data.records || [];
                    state.cats = data.cats || state.cats;
                    state.subs = data.subs || [];
                    document.getElementById('cloud-status').innerText = '雲端已同步 ✓';
                    render();
                } else {
                    document.getElementById('cloud-status').innerText = '新加密空間已就緒';
                    saveToCloud();
                }
            });
        }

        function saveToCloud() { 
            if(!state.uid) return;
            db.ref('users/' + state.uid).set({ records: state.records, cats: state.cats, subs: state.subs }); 
        }

        function logout() { auth.signOut().then(() => location.reload()); }

        window.onload = () => { 
            auth.onAuthStateChanged((user) => {
                if (user) handleAuthSuccess(user);
                else document.getElementById('sync-overlay').style.display='flex';
            });
        };
        
        // (其餘 render, chart 等邏輯請沿用前版，此處略)
    </script>
</body>
</html>
